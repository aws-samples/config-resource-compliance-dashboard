# DEPRECATED, this was an intermediate step.
# WIP template for v4.1.0
#
# AWS Config Resource Compliance Dashboard (CRCD)
# CRCD CIRT Conformance Pack
# Deploys to all regions where Config is active in target accounts. Does not automatically enable Config in new regions
# Skips regions where Config service is not running

AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS Config Resource Compliance Dashboard (CRCD) and AWS Customer Incident Response Team (CIRT) recommended Conformance Pack deployment - RUN from AWS Organizations management account or Config Delegated Admin'

Parameters:
  ExcludedAccounts:
    Type: CommaDelimitedList
    Description: "Comma-separated list of account IDs to exclude from deployment, e.g. '111111111111,222222222222' (optional)"
    Default: ""

  DeploymentTargets:
    Type: String
    Description: "Deployment scope - entire organization or specific OUs"
    AllowedValues: 
      - "ORGANIZATION"
      - "ORGANIZATIONAL_UNIT"
    Default: "ORGANIZATION"

  OrganizationalUnitIds:
    Type: CommaDelimitedList
    Description: "Comma-separated list of OU IDs (required if DeploymentTargets is ORGANIZATIONAL_UNIT)"
    Default: ""

Conditions:
  HasExcludedAccounts: !Not [!Equals [!Join ["", !Ref ExcludedAccounts], ""]]
  IsOUDeployment: !Equals [!Ref DeploymentTargets, "ORGANIZATIONAL_UNIT"]

Resources:
  # S3 Bucket to store the conformance pack template
  ConformancePackBucket:
  # checkov:skip=CKV_AWS_18: No need to have access logging on this bucket
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'crcd-cirt-conformance-pack-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  # Bucket policy for Config service access
  ConformancePackBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ConformancePackBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSConfigConformancePackDeliveryPermissionsCheck
            Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt ConformancePackBucket.Arn
            Condition:
              StringEquals:
                AWS:SourceAccount: !Ref AWS::AccountId
          - Sid: AWSConfigConformancePackDeliveryPermissions
            Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${ConformancePackBucket}/*'
            Condition:
              StringEquals:
                's3:x-amz-acl': bucket-owner-full-control
                AWS:SourceAccount: !Ref AWS::AccountId
          - Sid: AWSConfigConformancePackDeliveryPermissionsCheck2
            Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: s3:ListBucket
            Resource: !GetAtt ConformancePackBucket.Arn
            Condition:
              StringEquals:
                AWS:SourceAccount: !Ref AWS::AccountId

  # Custom Config Rule Lambda Function
  CustomConfigRuleFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'crcd-cirt-custom-rule-${AWS::Region}'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt CustomConfigRuleRole.Arn
      Code:
        ZipFile: |
          import boto3
          import json
          import datetime
          
          def lambda_handler(event, context):
              config_client = boto3.client('config')
              
              # Get the rule parameters
              rule_parameters = {}
              if 'ruleParameters' in event:
                  rule_parameters = json.loads(event['ruleParameters'])
              
              # Example: Check if account has CloudTrail enabled
              cloudtrail = boto3.client('cloudtrail')
              
              try:
                  # Get all trails
                  trails = cloudtrail.describe_trails()['trailList']
                  
                  # Check if any trail is logging
                  compliant = False
                  for trail in trails:
                      status = cloudtrail.get_trail_status(Name=trail['TrailARN'])
                      if status['IsLogging']:
                          compliant = True
                          break
                  
                  # Prepare evaluation result
                  evaluation = {
                      'ComplianceResourceType': 'AWS::::Account',
                      'ComplianceResourceId': event['accountId'],
                      'ComplianceType': 'COMPLIANT' if compliant else 'NON_COMPLIANT',
                      'OrderingTimestamp': datetime.datetime.now()
                  }
                  
                  # Submit evaluation to Config
                  config_client.put_evaluations(
                      Evaluations=[evaluation],
                      ResultToken=event['resultToken']
                  )
                  
              except Exception as e:
                  print(f'Error: {str(e)}')
                  # Submit failed evaluation
                  evaluation = {
                      'ComplianceResourceType': 'AWS::::Account',
                      'ComplianceResourceId': event['accountId'],
                      'ComplianceType': 'NOT_APPLICABLE',
                      'OrderingTimestamp': datetime.datetime.now()
                  }
                  config_client.put_evaluations(
                      Evaluations=[evaluation],
                      ResultToken=event['resultToken']
                  )

  CustomConfigRuleRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/ConfigRole
      Policies:
        - PolicyName: CloudTrailReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudtrail:DescribeTrails
                  - cloudtrail:GetTrailStatus
                  - config:PutEvaluations
                Resource: '*'

  # Permission for Config to invoke the Lambda function
  CustomConfigRuleLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CustomConfigRuleFunction
      Action: lambda:InvokeFunction
      Principal: config.amazonaws.com
      SourceAccount: !Ref AWS::AccountId

  # Lambda function to upload conformance pack template to S3
  ConformancePackUploader:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'crcd-cirt-conformance-pack-uploader-${AWS::Region}'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt ConformancePackUploaderRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import json
          
          def lambda_handler(event, context):
              try:
                  s3 = boto3.client('s3')
                  bucket_name = event['ResourceProperties']['BucketName']
                  
                  conformance_pack_template = '''ConformancePackName: crcd-cirt-security-recommendations
          Description: "Conformance pack for comprehensive security controls recommended by AWS Customer Incident Response Team (CIRT)"
          
          Resources:

            # ------------------------------------------------------------------------------------------
            # Initial Access
            # ------------------------------------------------------------------------------------------
            RootAccountMFAEnabled:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-iam-root-account-mfa-enabled
                Source:
                  Owner: AWS
                  SourceIdentifier: ROOT_ACCOUNT_MFA_ENABLED
                MaximumExecutionFrequency: TwentyFour_Hours

            IAMRootAccessKeyCheck:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-iam-iam-root-access-key-check
                Source:
                  Owner: AWS
                  SourceIdentifier: IAM_ROOT_ACCESS_KEY_CHECK
                MaximumExecutionFrequency: TwentyFour_Hours

            IAMUserMFAEnabled:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-iam-iam-user-mfa-enabled
                Source:
                  Owner: AWS
                  SourceIdentifier: IAM_USER_MFA_ENABLED

            MFAEnabledForIAMConsoleAccess:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-iam-mfa-enabled-for-iam-console-access
                Source:
                  Owner: AWS
                  SourceIdentifier: MFA_ENABLED_FOR_IAM_CONSOLE_ACCESS

            AutoscalingLaunchConfigRequiresIMDSv2:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-ec2-autoscaling-launchconfig-requires-imdsv2
                Source:
                  Owner: AWS
                  SourceIdentifier: AUTOSCALING_LAUNCH_CONFIG_PUBLIC_IP_DISABLED

            EC2IMDSv2Check:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-ec2-ec2-imdsv2-check
                Source:
                  Owner: AWS
                  SourceIdentifier: EC2_IMDSV2_CHECK

            EC2LaunchTemplateIMDSv2Check:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-ec2-ec2-launch-template-imdsv2-check
                Source:
                  Owner: AWS
                  SourceIdentifier: EC2_LAUNCH_TEMPLATE_IMDSV2_CHECK

            S3BucketPublicReadProhibited:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-bucket-public-read-prohibited
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_BUCKET_PUBLIC_READ_PROHIBITED

            S3BucketPublicWriteProhibited:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-bucket-public-write-prohibited
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_BUCKET_PUBLIC_WRITE_PROHIBITED

            S3AccessPointInVPCOnly:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-access-point-in-vpc-only
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_ACCESS_POINT_IN_VPC_ONLY

            S3AccessPointPublicAccessBlocks:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-access-point-public-access-blocks
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_ACCESS_POINT_PUBLIC_ACCESS_BLOCKS

            S3AccountLevelPublicAccessBlocks:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-account-level-public-access-blocks
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_ACCOUNT_LEVEL_PUBLIC_ACCESS_BLOCKS

            S3AccountLevelPublicAccessBlocksPeriodic:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-account-level-public-access-blocks-periodic
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_ACCOUNT_LEVEL_PUBLIC_ACCESS_BLOCKS_PERIODIC
                MaximumExecutionFrequency: TwentyFour_Hours

            S3BucketLevelPublicAccessProhibited:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-s3-s3-bucket-level-public-access-prohibited
                Source:
                  Owner: AWS
                  SourceIdentifier: S3_BUCKET_LEVEL_PUBLIC_ACCESS_PROHIBITED

            VPCSGPortRestrictionCheck:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-ra-vpc-sg-port-restriction-check
                Source:
                  Owner: AWS
                  SourceIdentifier: VPC_SG_PORT_RESTRICTION_CHECK

            # Custom Lambda-based rule for CloudTrail logging check
            CustomCloudTrailLoggingCheck:
              Type: AWS::Config::ConfigRule
              Properties:
                ConfigRuleName: crcd-cirt-ia-custom-cloudtrail-logging-enabled
                Source:
                  Owner: AWS_LAMBDA
                  SourceIdentifier: arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:crcd-cirt-custom-rule-${AWS::Region}
                  SourceDetail:
                    - EventSource: aws.config
                      MessageType: ScheduledNotification
                      MaximumExecutionFrequency: TwentyFour_Hours
                Scope:
                  ComplianceResourceTypes:
                    - "AWS::::Account"

            # ------------------------------------------------------------------------------------------
            # 2nd level TBC
            # ------------------------------------------------------------------------------------------

            # ------------------------------------------------------------------------------------------
            # 3rd level TBC
            # ------------------------------------------------------------------------------------------'''
                  
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      s3.put_object(
                          Bucket=bucket_name,
                          Key='crcd-cirt-conformance-pack.yaml',
                          Body=conformance_pack_template,
                          ContentType='text/yaml'
                      )
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                      'TemplateS3Uri': f's3://{bucket_name}/crcd-cirt-conformance-pack.yaml'
                  })
              except Exception as e:
                  print(f'Error: {str(e)}')
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  ConformancePackUploaderRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !Sub '${ConformancePackBucket}/*'

  # Custom resource to trigger the upload
  ConformancePackTemplateUpload:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt ConformancePackUploader.Arn
      BucketName: !Ref ConformancePackBucket

  # Organization Conformance Pack
  OrganizationConformancePack:
    Type: AWS::Config::OrganizationConformancePack
    DependsOn: ConformancePackTemplateUpload
    Properties:
      OrganizationConformancePackName: crcd-cirt-security-recommendations
      TemplateS3Uri: !GetAtt ConformancePackTemplateUpload.TemplateS3Uri
      DeliveryS3Bucket: !Ref ConformancePackBucket
      ExcludedAccounts: !If
        - HasExcludedAccounts
        - !Ref ExcludedAccounts
        - !Ref AWS::NoValue
      OrganizationalUnitIds: !If
        - IsOUDeployment
        - !Ref OrganizationalUnitIds
        - !Ref AWS::NoValue

Outputs:
  ConformancePackName:
    Description: "Name of the deployed conformance pack"
    Value: !Ref OrganizationConformancePack
    
  S3BucketName:
    Description: "S3 bucket containing the conformance pack template"
    Value: !Ref ConformancePackBucket
    
  TemplateLocation:
    Description: "S3 location of the conformance pack template"
    Value: !GetAtt ConformancePackTemplateUpload.TemplateS3Uri